<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pre-Factura</title>
    <meta name="description" content="Ortho Fracture" />
    <meta
      name="keywords"
      content="factura, ISV, Honduras, calculadora, impuestos, pre-factura, SAR"
    />
    <meta name="author" content="Jose Vega" />
    <link rel="canonical" href="https://jose-vega.netlify.app/" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Pre-Factura | Calculadora de Facturas con ISV"
    />
    <meta
      property="og:description"
      content="Calculadora de pre-factura con ISV para Honduras. Calcula automáticamente impuestos, descuentos y totales."
    />
    <meta property="og:url" content="https://jose-vega.netlify.app/" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta
      name="twitter:title"
      content="Pre-Factura | Calculadora de Facturas con ISV"
    />
    <meta
      name="twitter:description"
      content="Calculadora de pre-factura con ISV (15%) para Honduras"
    />
    <link rel="stylesheet" href="./assets/styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
  </head>

  <body>
    <div id="app">
      <div class="header">
        <div class="header-left">
          <img src="./assets/images/logo.jpg" alt="OrthoFracture" />
          <h1>Pre-Factura</h1>
        </div>
        <button class="btn" @click="resetInvoice">Reiniciar</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th class="center">Cantidad</th>
            <th class="right">Precio</th>
            <th class="center">ISV?</th>
            <th class="right">ISV (15%)</th>
            <th class="right">Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(item, index) in items" :key="item.id">
            <td data-label="Item">
              <input
                type="text"
                v-model="item.name"
                :placeholder="'Item ' + (index + 1)"
              />
            </td>

            <td data-label="Cantidad">
              <input
                type="number"
                v-model.number="item.quantity"
                min="1"
                step="1"
              />
            </td>

            <td data-label="Precio">
              <input
                type="number"
                v-model.number="item.price"
                min="0"
                step="0.01"
              />
            </td>

            <td data-label="ISV" class="checkbox-cell">
              <input type="checkbox" v-model="item.taxable" />
            </td>

            <td data-label="ISV (15%)" class="right tax-cell">
              Lps. {{ item.taxable ? calculateTax(item.price *
              item.quantity).toFixed(2) : "0.00" }}
            </td>

            <td data-label="Total" class="right strong">
              Lps. {{ ( item.price * item.quantity + (item.taxable ?
              calculateTax(item.price * item.quantity) : 0) ).toFixed(2) }}
            </td>

            <td data-label="Acción">
              <button
                class="btn btn-remove"
                @click="removeItem(index)"
                :disabled="items.length === 1"
              >
                ✕
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <button class="btn btn-add" @click="addItem">+ Agregar Item</button>

      <div class="totals">
        <div class="total-row">
          <span>Subtotal</span>
          <span>Lps. {{ subtotal.toFixed(2) }}</span>
        </div>

        <div class="total-row discount-row">
          <span>(-) Descuento</span>
          <div class="total-value discount-input">
            <input
              type="number"
              v-model.number="discountPercent"
              min="0"
              max="100"
              step="0.1"
            />
            <span>% = Lps. {{ discountAmount.toFixed(2) }}</span>
          </div>
        </div>

        <div class="total-row strong bordered">
          <span>Subtotal Neto</span>
          <span>Lps. {{ subtotalNeto.toFixed(2) }}</span>
        </div>
        <div class="total-row">
          <span>ISV (15%)</span>
          <span>Lps. {{ totalTax.toFixed(2) }}</span>
        </div>
        <div class="total-row final">
          <span>TOTAL A PAGAR</span>
          <span>Lps. {{ finalTotal.toFixed(2) }}</span>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            items: [{ id: 1, name: "", price: 0, quantity: 1, taxable: true }],
            discountPercent: 0,
            taxRate: 0.15,
          };
        },
        computed: {
          subtotal() {
            return this.items.reduce(
              (sum, item) =>
                sum + (Number(item.price) || 0) * (Number(item.quantity) || 0),
              0
            );
          },
          discountAmount() {
            return this.subtotal * (this.discountPercent / 100);
          },
          subtotalNeto() {
            return this.subtotal - this.discountAmount;
          },
          totalTax() {
            const taxableSubtotal = this.items.reduce((sum, item) => {
              if (item.taxable) {
                return (
                  sum + (Number(item.price) || 0) * (Number(item.quantity) || 0)
                );
              }
              return sum;
            }, 0);

            const taxableAfterDiscount =
              this.subtotal > 0
                ? taxableSubtotal * (this.subtotalNeto / this.subtotal)
                : 0;

            return taxableAfterDiscount * this.taxRate;
          },
          finalTotal() {
            return this.subtotalNeto + this.totalTax;
          },
        },
        methods: {
          addItem() {
            this.items.push({
              id: Date.now(),
              name: "",
              price: 0,
              quantity: 1,
              taxable: true,
            });
          },
          removeItem(index) {
            if (this.items.length > 1) this.items.splice(index, 1);
          },
          calculateTax(price) {
            return (Number(price) || 0) * this.taxRate;
          },
          resetInvoice() {
            this.items = [
              {
                id: Date.now(),
                name: "",
                price: 0,
                quantity: 1,
                taxable: true,
              },
            ];
            this.discountPercent = 0;
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
